#!/bin/zsh

i3_config_file="$HOME/.config/i3/config"
i3_includes_file="$HOME/.config/i3/partials/imports.conf"

[[ -f "$i3_config_file" ]] && rm "$i3_config_file"

touch "$i3_config_file"

echo "# Do NOT edit this file directly, it will be overwritten by generate_config" >> "$i3_config_file"
echo "# You can edit the files here instead: ~/.config/i3/partials/*" >> "$i3_config_file"

include_file() {
  cat "$HOME/.config/i3/partials/$1" >> "$i3_config_file"
}

get_file_name_from_line () {
  removed_semicolon="${1%;*}"
  file_name="$(echo ${removed_semicolon#import} | sed 's/ //')"
  echo "$file_name"
}

exec 3< "$i3_includes_file"

until [ "$done" ]
do
   read <&3 config_line

   if [ $? != 0 ]; then
     done=1
     continue
   else
     if [[ "$config_line[1,1]" != "#" && "$config_line" != "" ]]; then
       file_name="$(get_file_name_from_line $config_line)"
       include_file "$file_name"
     fi
   fi
done
